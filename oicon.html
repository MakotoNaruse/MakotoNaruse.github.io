<!DOCTYPE html>
<html lang="ja" dir="ltr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,user-scalable=no,maximum-scale=1">
<title>桃鉄マップ</title>
<!----css---->
<link rel="stylesheet" href="css/style.css">
<!----js---->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
</head>
<body>
    <main>
        <div id="map-wrap">
            <div id="map-canvas">
            </div>
        </div>
    </main>
</body>

<script type="text/javascript" src="https://maps.google.com/maps/api/js?key=AIzaSyChKLMM6Y7F0q14OUZV_eEy5SLG-F_s5a0"></script>
<script src="js/markerwithlabel.js"></script>
<script>

    var map;
    var marker = [];
    var infoWindow = [];

    function initMap(address) {
        console.log("接続完了");
        var geocoder = new google.maps.Geocoder();
        //住所から座標を取得する
        geocoder.geocode(
                {
                    'address': address,
                    'region': 'jp'
                },
                function (results, status) {
                    if (status == google.maps.GeocoderStatus.OK) {
                        google.maps.event.addDomListener(window, 'load', function () {
                            var map_tag = document.getElementById('map-canvas');
                            // 取得した座標をセット緯度経度をセット
                            var map_location = new google.maps.LatLng(results[0].geometry.location.lat(),results[0].geometry.location.lng());
                            //マップ表示のオプション
                            var map_options =
                            {
                                zoom: 15,//縮尺
                                gestureHandling: 'greedy',
                                clickableIcons: false,
                                center: map_location,//地図の中心座標
                                //ここをfalseにすると地図上に人みたいなアイコンとか表示される
                                disableDefaultUI: true, //一旦全て非表示
                                zoomControl: true, //ズーム コントロールのみ表示
                                mapTypeId: google.maps.MapTypeId.ROADMAP//地図の種類を指定
                            };

                            //マップを表示する
                            map = new google.maps.Map(map_tag, map_options);

                            //読み込みが完了したら検索
                            google.maps.event.addListenerOnce(map, 'idle', function() {
                                makeMap();
                            });
                            map.addListener('click', function(pos) {
                                console.log(pos.latLng.lat(), pos.latLng.lng());
                            });
                        });
                    }
                }
        );
    }

    function makeMap () {
        console.log("マップ作成");
        data = [
            {"lat": "35.028784062101586",
             "lng": "135.77923866394048",
             "type": "station-blue",
             "name": "百万遍"},
             {"lat": "35.02855372256138",
              "lng": "135.78304763608173",
              "type": "station-red",
              "name": "京大農学部前"},
              {"lat": "35.028879333769424",
               "lng": "135.7862139838238",
               "type": "station-yellow",
               "name": "北白川"},
               {"lat": "35.027908536319565",
                "lng": "135.79142819814876",
                "type": "station-card",
                "name": "銀閣寺道"},
                {"lat": "35.02522284598233",
                 "lng": "135.7785907657684",
                 "type": "station-blue",
                 "name": "京大正門前"},
                 {"lat": "35.02186219383679",
                  "lng": "135.77856394367825",
                  "type": "station-red",
                  "name": "近衛通り"},
                  {"lat": "35.020390492215675",
                   "lng": "135.77847811298977",
                   "type": "station-card",
                   "name": "京大病院前"},
                   {"lat": "35.017359180358596",
                    "lng": "135.7783869229897",
                    "type": "station-blue",
                    "name": "熊野神社前"},
                    {"lat": "35.01695744604054",
                     "lng": "135.78575763336264",
                     "type": "station-red",
                     "name": "岡崎道"},
        ];
        for(let i = 0; i < data.length; i++ ){
            content = "　";
            if( data[i].type == "station-card"){
                content = "★";
            }
            var marker_location = new google.maps.LatLng(data[i].lat,data[i].lng);
            console.log(marker_location);
            marker[i] = new MarkerWithLabel({
                position: marker_location, //マーカーを表示させる座標
                map: map, //マーカーを表示させる地図
                icon: {
                    fillColor: "#333333",                //塗り潰し色
                    fillOpacity: 0,                    //透明にする
                    path: google.maps.SymbolPath.CIRCLE,
                },
                labelContent: content,                   //ラベル文字
                labelAnchor: new google.maps.Point(12, 12),   //ラベル文字の基点
                labelClass: data[i].type,                        //CSSのクラス名
                labelStyle: {opacity: 1}
            });
            infoWindow[i] = new google.maps.InfoWindow({ // 吹き出しの追加
                content: data[i].name // 吹き出しに表示する内容
            });
            markerEvent(i);

        }
    }

    function markerEvent(i) {
        marker[i].addListener('click', function() { // マーカーをクリックしたとき
            //map.panTo(marker[i].position);
            //他の吹き出しを削除する
            for(let j = 0; j < marker.length; j++ ){
                infoWindow[j].close();
            }
            infoWindow[i].open(map, marker[i]); // 吹き出しの表示
        });
    }

    function deleteMarkers() {
        //マーカーを削除する
        if(marker != null ){
            for(let j = 0; j < marker.length; j++ ){
                if(marker[j] != null){
    		        marker[j].setMap(null);
    		    }
            }
            marker = null;
        }
    }

$(document).ready(function() {

    initMap('京都大学');

});

</script>
</html>
